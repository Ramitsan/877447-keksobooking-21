(()=>{"use strict";window.util={ESC_KEYCODE:27,ENTER_KEYCODE:13,isEscPress:e=>e.keyCode===window.util.ESC_KEYCODE,isEnterPress:e=>e.keyCode===window.util.ENTER_KEYCODE,disableElements:e=>{e.forEach((e=>{e.disabled=!0}))},enableElements:e=>{e.forEach((e=>{e.disabled=!1}))}},(()=>{const e=(e,t,o,r,n)=>{let s=new XMLHttpRequest;s.responseType="json",s.timeout=3e3,s.open(t,e),s.addEventListener("load",(()=>{switch(s.status){case 200:r(s.response);break;case 400:n("Неправильный запрос.  Код ошибки  "+s.status);break;case 404:n("Страница не найдена. Код ошибки "+s.status);break;case 500:n("Внутренняя ошибка сервера. Код ошибки "+s.status);break;default:n(`При загрузке произошла ошибка ${s.status}. Повторите попытку позже.`)}})),s.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${s.timeout} мс`)})),s.send(o)};window.backend={save:(t,o,r)=>{e("https://21.javascript.pages.academy/keksobooking","POST",t,o,r)},load:(t,o)=>{e("https://21.javascript.pages.academy/keksobooking/data","GET",null,t,o)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t="img/muffin-grey.svg",o=document.querySelector("#avatar"),r=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__input"),s=document.querySelector(".ad-form__photo");s.style.display="flex",s.insertAdjacentHTML("afterbegin",'<img src="img/muffin-grey.svg" alt="Фотография жилья" width="50" height="50" style="margin: 10px;">');const a=s.firstChild,i=(t,o)=>{t.addEventListener("change",(()=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(r)}}))};i(o,r),i(n,a),window.chooserImage={remove:()=>{r.src=t,a.src=t}}})(),(()=>{const e={bungalow:"0",house:"5000",flat:"1000",palace:"10000"},t={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},o={1:"1 комната — для 1 гостя",2:"2 комнаты — для 1 или 2 гостей",3:"3 комнаты — для 1 или 2 или 3 гостей",100:"100 комнат — не для гостей"},r=document.querySelector(".ad-form"),n=r.querySelectorAll(".ad-form__element"),s=r.querySelector("#address"),a=r.querySelector(".ad-form__reset"),i=r.querySelector("#room_number"),d=r.querySelector("#capacity"),l=r.querySelector(".ad-form__submit"),c=r.querySelector("#title"),u=r.querySelector("#type"),m=r.querySelector("#price"),p=r.querySelector(".ad-form__element--time"),w=r.querySelector("#timein"),f=r.querySelector("#timeout");c.addEventListener("input",(()=>{const e=c.value.length;e<30?c.setCustomValidity(`Минимальная длина заголовка - 30 символов. Наберите еще ${30-e} символов`):e>100?c.setCustomValidity(`Максимальная длина заголовка - 100 символов. Удалите ${e-30} символов`):c.setCustomValidity("")})),u.addEventListener("change",(()=>{const t=e[u.value];m.placeholder=t,m.min=t})),p.addEventListener("change",(e=>{w.value=e.target.value,f.value=e.target.value})),l.addEventListener("click",(()=>{d.setCustomValidity((()=>{const e=o[i.value];return t[i.value].includes(d.value)?"":e})())})),window.form={element:r,resetElement:a,disable:()=>{r.classList.add("ad-form--disabled"),r.reset(),window.chooserImage.remove(),window.util.disableElements(n)},enable:()=>{r.classList.remove("ad-form--disabled"),window.util.enableElements(n)},setAddress:e=>{s.value=`${e.x}, ${e.y}`}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},o=e=>{window.util.isEscPress(e)&&r()},r=()=>{const e=window.map.element.querySelector(".map__card");e&&(window.pin.removeActive(),e.remove(),document.removeEventListener("keydown",o))};window.card={create:n=>{const s=e.cloneNode(!0);return s.querySelector(".popup__title").textContent=n.offer.title,s.querySelector(".popup__text--address").textContent=n.offer.address,s.querySelector(".popup__text--price").textContent=n.offer.price+"₽/ночь",s.querySelector(".popup__type").textContent=t[n.offer.type],s.querySelector(".popup__text--capacity").textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`,s.querySelector(".popup__text--time").textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout}`,s.querySelector(".popup__description").textContent=n.offer.description,s.querySelector(".popup__avatar").src=n.author.avatar,((e,t)=>{if(0===t.offer.features.length)e.querySelector(".popup__features").style.display="none";else{const o=e.querySelector(".popup__features");o.style.display="block";const r=t.offer.features;o.innerHTML="",r.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),o.append(t)}))}})(s,n),((e,t)=>{if(0===t.offer.photos.length)e.querySelector(".popup__photos").style.display="none";else{const o=e.querySelector(".popup__photos");o.style.display="block";const r=t.offer.photos;o.innerHTML="",r.forEach((e=>{const t=document.createElement("img");t.classList.add("popup__photo"),t.style.width="45px",t.style.height="40px",t.src=e,o.append(t)}))}})(s,n),s.querySelectorAll(":not(img)").forEach((function(e){e.innerHTML||e.remove()})),s.querySelector(".popup__close").addEventListener("click",(()=>{r()})),document.addEventListener("keydown",o),s},remove:r}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={render:t=>{let o=e.cloneNode(!0),r=o.querySelector("img");return o.style.top=t.location.y-44-5+"px",o.style.left=t.location.x-20+"px",r.src=t.author.avatar,r.alt=t.offer.title,o},removeActive:()=>{let e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e="low",t=1e4,o="middle",r=1e4,n=5e4,s="high",a=5e4,i="any",d=document.querySelector(".map__filters"),l=d.querySelector("#housing-type"),c=d.querySelector("#housing-price"),u=d.querySelector("#housing-rooms"),m=d.querySelector("#housing-guests"),p=p=>p.filter((p=>{return f=p,(l.value===i||f.offer.type===l.value)&&(d=>c.value===i||d.offer.price<t&&c.value===e||d.offer.price>a&&c.value===s||d.offer.price>=r&&d.offer.price<=n&&c.value===o)(p)&&(e=>u.value===i||e.offer.rooms===parseInt(u.value,10))(p)&&(e=>m.value===i||e.offer.guests===parseInt(m.value,10))(p)&&(w=p.offer.features,Array.from(d.querySelectorAll('input[type="checkbox"]:checked')).every((e=>w.includes(e.value))));var w,f})).slice(0,5);window.filters={setFilteredPins:(e,t)=>{let o=window.debounce((()=>{t(p(e))}));d.addEventListener("change",(()=>{o()})),t(p(e))},clear:()=>{d.reset()}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=e.querySelector(".map__filters-container"),r=document.querySelector(".map__filters"),n=r.querySelectorAll(".map__filter"),s=r.querySelector(".map__features"),a=()=>{window.util.enableElements(n)};window.map={element:e,mapFiltersForm:r,disable:()=>{e.classList.add("map--faded"),window.card.remove(),window.map.removePins(),r.classList.add("ad-form--disabled"),window.util.disableElements(n),s.disabled=!0,window.mainPin.reset()},enable:()=>{e.classList.remove("map--faded"),r.classList.remove("ad-form--disabled"),a(),s.disabled=!1},addPins:r=>{t.appendChild((t=>{let r=document.createDocumentFragment();return t.forEach((t=>{let n=window.pin.render(t);n.addEventListener("click",(()=>{var r;window.card.remove(),r=window.card.create(t),window.card.remove(),e.insertBefore(r,o),n.classList.add("map__pin--active")})),r.appendChild(n)})),r})(r))},removePins:()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{t.removeChild(e)}))}}})(),(()=>{const e=window.map.element.offsetWidth-32.5,t=document.querySelector(".map__pin--main"),o=t.style.left,r=t.style.top,n=()=>{const e=t.offsetLeft,o=t.offsetTop;let r={};return r=window.map.element.classList.contains("map--faded")?{x:Math.round(e+32.5),y:Math.round(o+32.5)}:{x:Math.round(e+32.5),y:Math.round(o+83)},r};t.addEventListener("mousedown",(o=>{o.preventDefault();let r={x:o.clientX,y:o.clientY};const s=o=>{o.preventDefault();let s=r.x-o.clientX,a=r.y-o.clientY;r={x:o.clientX,y:o.clientY};let i=t.offsetLeft-s,d=t.offsetTop-a;i>=-32.5&&i<=e&&(t.style.left=t.offsetLeft-s+"px"),d>=47&&d<=547&&(t.style.top=t.offsetTop-a+"px"),window.form.setAddress(n())},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",a)})),window.mainPin={element:t,getAddress:n,reset:()=>{t.style.left=o,t.style.top=r}}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success"),t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("main"),r=e.cloneNode(!0);document.addEventListener("keydown",(e=>{window.util.isEscPress(e)&&r.remove()})),document.addEventListener("click",(e=>{e.target===r&&r.remove()}));const n=t.cloneNode(!0);n.querySelector(".error__button").addEventListener("click",(()=>{n.remove()})),document.addEventListener("keydown",(e=>{window.util.isEscPress(e)&&n.remove()})),document.addEventListener("click",(e=>{e.target===n&&n.remove()})),window.message={showSuccess:()=>{o.appendChild(r)},showError:e=>{n.style.backgroundColor="rgba(255, 86, 53, 0.7)",o.appendChild(n),n.querySelector(".error__message").textContent=e}}})(),(()=>{const e=()=>{window.filters.clear(),window.map.disable(),window.form.disable(),window.form.setAddress(window.mainPin.getAddress())},t=()=>{window.map.enable(),window.form.enable(),window.form.setAddress(window.mainPin.getAddress()),window.backend.load((e=>{let t=e.filter((e=>"offer"in e));window.filters.setFilteredPins(t,o)}),n)},o=e=>{window.map.removePins(),window.card.remove(),window.map.addPins(e)};window.form.element.addEventListener("submit",(e=>{e.preventDefault(),window.form.element.checkValidity()&&window.backend.save(new FormData(window.form.element),r,n)})),window.form.resetElement.addEventListener("click",(()=>{e()}));const r=()=>{window.message.showSuccess(),e()},n=e=>{window.message.showError(e)};window.mainPin.element.addEventListener("mousedown",(e=>{0===e.button&&t()})),window.mainPin.element.addEventListener("keydown",(e=>{window.util.isEnterPress(e)&&t()})),e()})()})();