(()=>{"use strict";window.util={ESC_KEYCODE:27,ENTER_KEYCODE:13,isEscPress:e=>e.keyCode===window.util.ESC_KEYCODE,isEnterPress:e=>e.keyCode===window.util.ENTER_KEYCODE,disableElements:e=>{e.forEach((e=>{e.disabled=!0}))},enableElements:e=>{e.forEach((e=>{e.disabled=!1}))}},(()=>{const e=(e,t,o,r,n)=>{let s=new XMLHttpRequest;s.responseType="json",s.timeout=3e3,s.open(t,e),s.addEventListener("load",(()=>{switch(s.status){case 200:r(s.response);break;case 400:n("Неправильный запрос.  Код ошибки "+s.status);break;case 404:n("Страница не найдена. Код ошибки "+s.status);break;case 500:n("Внутренняя ошибка сервера. Код ошибки "+s.status);break;default:n("При загрузке произошла ошибка "+s.status+". Повторите попытку позже.")}})),s.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за "+s.timeout+"мс")})),s.send(o)};window.backend={save:(t,o,r)=>{e("https://21.javascript.pages.academy/keksobooking","POST",t,o,r)},load:(t,o)=>{e("https://21.javascript.pages.academy/keksobooking/data","GET",null,t,o)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#avatar"),o=document.querySelector(".ad-form-header__preview img"),r=document.querySelector("#images"),n=document.querySelector(".ad-form__photo"),s="img/muffin-grey.svg";n.style.display="flex",n.insertAdjacentHTML("afterbegin",'<img src="img/muffin-grey.svg" alt="Фотография жилья" width="50" height="50" style="margin: 10px;">');const i=n.firstChild,d=(t,o)=>{t.addEventListener("change",(()=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){var s=new FileReader;s.addEventListener("load",(()=>{o.src=s.result})),s.readAsDataURL(r)}}))};d(t,o),d(r,i),window.chooserImage={remove:()=>{o.src=s,i.src=s}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelectorAll(".ad-form__element"),o=e.querySelector("#address"),r=e.querySelector(".ad-form__reset"),n=e.querySelector("#room_number"),s=e.querySelector("#capacity");e.querySelector(".ad-form__submit").addEventListener("click",(()=>{const e=n.value,t=s.value;"100"===e&&"0"!==t?n.setCustomValidity("100 комнат — не для гостей"):"1"===e&&"1"!==t?n.setCustomValidity("1 комната — для 1 гостя"):"2"!==e||"1"===t&&"2"===t?"3"===e&&"0"===t?n.setCustomValidity("3 комнаты — для 1 или 2 или 3 гостей"):n.setCustomValidity(""):n.setCustomValidity("2 комнаты — для 1 или 2 гостей")}));const i=e.querySelector("#title");i.addEventListener("input",(()=>{const e=i.value.length;e<30?i.setCustomValidity(`Минимальная длина заголовка - 30 символов. Наберите еще ${30-e} символов`):e>100?i.setCustomValidity(`Максимальная длина заголовка - 100 символов. Удалите ${e-30} символов`):i.setCustomValidity("")}));const d=e.querySelector("#type"),a=e.querySelector("#price");d.addEventListener("change",(()=>{switch(d.value){case"bungalow":a.min="0",a.placeholder="0";break;case"flat":a.min="1000",a.placeholder="1 000";break;case"house":a.min="5000",a.placeholder="5 000";break;case"palace":a.min="10000",a.placeholder="10 000"}}));const l=e.querySelector(".ad-form__element--time"),c=e.querySelector("#timein"),u=e.querySelector("#timeout");l.addEventListener("change",(e=>{c.value=e.target.value,u.value=e.target.value})),window.form={element:e,resetElement:r,disable:()=>{e.classList.add("ad-form--disabled"),e.reset(),window.chooserImage.remove(),window.util.disableElements(t)},enable:()=>{e.classList.remove("ad-form--disabled"),window.util.enableElements(t)},setAddress:e=>{o.value=`${e.x}, ${e.y}`}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},o=e=>{window.util.isEscPress(e)&&r()},r=()=>{const e=window.map.element.querySelector(".map__card");e&&(window.pin.removeActivePin(),e.remove(),document.removeEventListener("keydown",o))};window.card={create:n=>{const s=e.cloneNode(!0);return s.querySelector(".popup__title").textContent=n.offer.title,s.querySelector(".popup__text--address").textContent=n.offer.address,s.querySelector(".popup__text--price").textContent=n.offer.price+"₽/ночь",s.querySelector(".popup__type").textContent=t[n.offer.type],s.querySelector(".popup__text--capacity").textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`,s.querySelector(".popup__text--time").textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout}`,s.querySelector(".popup__description").textContent=n.offer.description,s.querySelector(".popup__avatar").src=n.author.avatar,((e,t)=>{if(0===t.offer.features.length)e.querySelector(".popup__features").style.display="none";else{const o=e.querySelector(".popup__features");o.style.display="block";const r=t.offer.features;o.innerHTML="",r.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),o.append(t)}))}})(s,n),((e,t)=>{if(0===t.offer.photos.length)e.querySelector(".popup__photos").style.display="none";else{const o=e.querySelector(".popup__photos");o.style.display="block";const r=t.offer.photos;o.innerHTML="",r.forEach((e=>{const t=document.createElement("img");t.classList.add("popup__photo"),t.style.width="45px",t.style.height="40px",t.src=e,t.addEventListener("click",(()=>{window.bigPicture.open(t)})),o.append(t)}))}})(s,n),s.querySelector(".popup__close").addEventListener("click",(()=>{r()})),document.addEventListener("keydown",o),s},remove:r}})(),(()=>{let e,t;const o=()=>{e.remove(),t.remove(),e.removeEventListener("click",o),t.removeEventListener("click",o)},r=e=>{window.util.isEscPress(e)&&o()};window.bigPicture={open:n=>{const s=document.createElement("img");s.src=n.src,s.style.width="auto",s.style.height="auto",s.style.border="10px solid #ffffff",e=(()=>{let e=document.createElement("div");return e.style.position="fixed",e.style.backgroundColor="rgba(0,0,0,0.8)",e.style.left=0,e.style.top=0,e.style.right=0,e.style.bottom=0,e.style.zIndex=99,e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e})(),t=(()=>{let e=document.createElement("button");return e.style.position="fixed",e.style.backgroundColor="transparent",e.style.right=0,e.style.top=0,e.style.width="55px",e.style.height="65px",e.style.display="block",e.style.border="1px solid transparent",e.style.fontSize="50px",e.textContent="×",e.style.color="#ffffff",e.style.padding="0",e.style.cursor="pointer",e.style.zIndex=100,e})(),document.body.appendChild(e),document.body.appendChild(t),s.addEventListener("load",(()=>{e.appendChild(s)})),e.addEventListener("click",(e=>{e.target!==s&&o()})),t.addEventListener("click",o),document.addEventListener("keydown",r)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={render:t=>{let o=e.cloneNode(!0),r=o.querySelector("img");return o.style.top=t.location.y-44-5+"px",o.style.left=t.location.x-20+"px",r.src=t.author.avatar,r.alt=t.offer.title,o},removeActivePin:()=>{let e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")}}})(),window.debounce=e=>{var t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),n=t.querySelector("#housing-rooms"),s=t.querySelector("#housing-guests"),i=i=>i.filter((i=>{return(t=>o.value===e||t.offer.type===o.value)(i)&&(t=>r.value===e||t.offer.price<1e4&&"low"===r.value||t.offer.price>5e4&&"high"===r.value||t.offer.price>=1e4&&t.offer.price<=5e4&&"middle"===r.value)(i)&&(t=>n.value===e||t.offer.rooms===parseInt(n.value,10))(i)&&(t=>s.value===e||t.offer.guests===parseInt(s.value,10))(i)&&(d=i.offer.features,Array.from(t.querySelectorAll('input[type="checkbox"]:checked')).every((e=>d.includes(e.value))));var d})).slice(0,5);window.filters={setFilteredPins:(e,o)=>{let r=window.debounce((()=>{o(i(e))}));t.addEventListener("change",(()=>{r()})),o(i(e))},clear:()=>{t.reset()}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=e.querySelector(".map__filters-container"),r=document.querySelector(".map__filters"),n=r.querySelectorAll(".map__filter"),s=r.querySelector(".map__features"),i=()=>{window.util.enableElements(n)};window.map={element:e,mapFiltersForm:r,disable:()=>{e.classList.add("map--faded"),window.card.remove(),window.map.removePins(),r.classList.add("ad-form--disabled"),window.util.disableElements(n),s.disabled=!0,window.mainPin.reset()},enable:()=>{e.classList.remove("map--faded"),r.classList.remove("ad-form--disabled"),i(),s.disabled=!1},addPins:r=>{t.appendChild((t=>{let r=document.createDocumentFragment();return t.forEach((t=>{let n=window.pin.render(t);n.addEventListener("click",(()=>{var r;window.card.remove(),r=window.card.create(t),window.card.remove(),e.insertBefore(r,o),n.classList.add("map__pin--active")})),r.appendChild(n)})),r})(r))},removePins:()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{t.removeChild(e)}))}}})(),(()=>{const e=window.map.element.offsetWidth-32.5,t=document.querySelector(".map__pin--main"),o=t.style.left,r=t.style.top,n=()=>{const e=t.offsetLeft,o=t.offsetTop;let r={};return r=window.map.element.classList.contains("map--faded")?{x:Math.round(e+32.5),y:Math.round(o+32.5)}:{x:Math.round(e+32.5),y:Math.round(o+83)},r};t.addEventListener("mousedown",(o=>{o.preventDefault();let r={x:o.clientX,y:o.clientY};const s=o=>{o.preventDefault();let s=r.x-o.clientX,i=r.y-o.clientY;r={x:o.clientX,y:o.clientY};let d=t.offsetLeft-s,a=t.offsetTop-i;d>=-32.5&&d<=e&&(t.style.left=t.offsetLeft-s+"px"),a>=47&&a<=547&&(t.style.top=t.offsetTop-i+"px"),window.form.setAddress(n())},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",i)})),window.mainPin={element:t,getAddress:n,reset:()=>{t.style.left=o,t.style.top=r}}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success"),t=document.querySelector("#error").content.querySelector(".error"),o=e.cloneNode(!0);document.addEventListener("keydown",(e=>{window.util.isEscPress(e)&&o.remove()})),document.addEventListener("click",(e=>{e.target===o&&o.remove()}));const r=t.cloneNode(!0);r.querySelector(".error__button").addEventListener("click",(()=>{r.remove()})),document.addEventListener("keydown",(e=>{window.util.isEscPress(e)&&r.remove()})),document.addEventListener("click",(e=>{e.target===r&&r.remove()})),window.message={showSuccess:()=>{document.querySelector("main").appendChild(o)},showError:e=>{r.style.backgroundColor="rgba(255, 86, 53, 0.7)",document.querySelector("main").appendChild(r),r.querySelector(".error__message").textContent=e}}})(),(()=>{const e=()=>{window.filters.clear(),window.map.disable(),window.form.disable(),window.form.setAddress(window.mainPin.getAddress())},t=()=>{window.map.enable(),window.form.enable(),window.form.setAddress(window.mainPin.getAddress()),window.backend.load((e=>{let t=e.filter((e=>"offer"in e));window.filters.setFilteredPins(t,o)}),n)},o=e=>{window.map.removePins(),window.card.remove(),window.map.addPins(e)};window.form.element.addEventListener("submit",(e=>{e.preventDefault(),window.form.element.checkValidity()&&window.backend.save(new FormData(window.form.element),r,n)})),window.form.resetElement.addEventListener("click",(()=>{e()}));const r=()=>{window.message.showSuccess(),e()},n=e=>{window.message.showError(e)};window.mainPin.element.addEventListener("mousedown",(e=>{0===e.button&&t()})),window.mainPin.element.addEventListener("keydown",(e=>{window.util.isEnterPress(e)&&t()})),e()})()})();