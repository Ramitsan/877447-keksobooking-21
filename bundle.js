(()=>{"use strict";window.util={ESC_KEYCODE:27,ENTER_KEYCODE:13,isEscPress:function(e){return e.keyCode===window.util.ESC_KEYCODE},isEnterPress:function(e){return e.keyCode===window.util.ENTER_KEYCODE},disableElements:function(e){e.forEach((e=>{e.disabled=!0}))},enableElements:function(e){e.forEach((e=>{e.disabled=!1}))}},(()=>{const e=(e,t,o,n,r)=>{let s=new XMLHttpRequest;s.responseType="json",s.timeout=3e3,s.open(t,e),s.addEventListener("load",(()=>{switch(s.status){case 200:n(s.response);break;case 400:r("Неправильный запрос.  Код ошибки "+s.status);break;case 404:r("Страница не найдена. Код ошибки "+s.status);break;case 500:r("Внутренняя ошибка сервера. Код ошибки "+s.status);break;default:r("При загрузке произошла ошибка "+s.status+". Повторите попытку позже.")}})),s.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за "+s.timeout+"мс")})),s.send(o)};window.backend={save:function(t,o,n){e("https://21.javascript.pages.academy/keksobooking","POST",t,o,n)},load:function(t,o){e("https://21.javascript.pages.academy/keksobooking/data","GET",null,t,o)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#avatar"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector("#images"),r=document.querySelector(".ad-form__photo"),s="img/muffin-grey.svg";r.style.display="flex",r.insertAdjacentHTML("afterbegin",'<img src="img/muffin-grey.svg" alt="Фотография жилья" width="50" height="50" style="margin: 10px;">');const i=r.firstChild,l=(t,o)=>{t.addEventListener("change",(()=>{const n=t.files[0],r=n.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){var s=new FileReader;s.addEventListener("load",(()=>{o.src=s.result})),s.readAsDataURL(n)}}))};l(t,o),l(n,i),window.chooserImage={remove:()=>{o.src=s,i.src=s}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelectorAll(".ad-form__element"),o=e.querySelector("#address"),n=e.querySelector(".ad-form__reset"),r=e.querySelector("#room_number"),s=e.querySelector("#capacity");e.querySelector(".ad-form__submit").addEventListener("click",(()=>{const e=r.value,t=s.value;"100"===e&&"0"!==t?r.setCustomValidity("100 комнат — не для гостей"):"1"===e&&"1"!==t?r.setCustomValidity("1 комната — для 1 гостя"):"2"!==e||"1"===t&&"2"===t?"3"===e&&"0"===t?r.setCustomValidity("3 комнаты — для 1 или 2 или 3 гостей"):r.setCustomValidity(""):r.setCustomValidity("2 комнаты — для 1 или 2 гостей")}));const i=e.querySelector("#title");i.addEventListener("input",(()=>{const e=i.value.length;e<30?i.setCustomValidity(`Минимальная длина заголовка - 30 символов. Наберите еще ${30-e} символов`):e>100?i.setCustomValidity(`Максимальная длина заголовка - 100 символов. Удалите ${e-30} символов`):i.setCustomValidity("")}));const l=e.querySelector("#type"),d=e.querySelector("#price");l.addEventListener("change",(()=>{switch(l.value){case"bungalow":d.min="0",d.placeholder="0";break;case"flat":d.min="1000",d.placeholder="1 000";break;case"house":d.min="5000",d.placeholder="5 000";break;case"palace":d.min="10000",d.placeholder="10 000"}}));const a=e.querySelector(".ad-form__element--time"),c=e.querySelector("#timein"),u=e.querySelector("#timeout");a.addEventListener("change",(e=>{c.value=e.target.value,u.value=e.target.value})),window.form={element:e,resetElement:n,disable:()=>{e.classList.add("ad-form--disabled"),e.reset(),window.chooserImage.remove(),window.util.disableElements(t)},enable:()=>{e.classList.remove("ad-form--disabled"),window.util.enableElements(t)},setAddress:e=>{o.value=`${e.x}, ${e.y}`}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},o=e=>{window.util.isEscPress(e)&&n()},n=()=>{const e=window.map.element.querySelector(".map__card");e&&(window.map.removeActivePin(),e.remove(),document.removeEventListener("keydown",o))};window.card={create:r=>{const s=e.cloneNode(!0);return s.querySelector(".popup__title").textContent=r.offer.title,s.querySelector(".popup__text--address").textContent=r.offer.address,s.querySelector(".popup__text--price").textContent=r.offer.price+"₽/ночь",s.querySelector(".popup__type").textContent=t[r.offer.type],s.querySelector(".popup__text--capacity").textContent=`${r.offer.rooms} комнаты для ${r.offer.guests} гостей`,s.querySelector(".popup__text--time").textContent=`Заезд после ${r.offer.checkin}, выезд до ${r.offer.checkout}`,s.querySelector(".popup__description").textContent=r.offer.description,s.querySelector(".popup__avatar").src=r.author.avatar,((e,t)=>{if(0===t.offer.features.length)e.querySelector(".popup__features").style.display="none";else{const o=e.querySelector(".popup__features");o.style.display="block";const n=t.offer.features;o.innerHTML="",n.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),o.append(t)}))}})(s,r),((e,t)=>{if(0===t.offer.photos.length)e.querySelector(".popup__photos").style.display="none";else{const o=e.querySelector(".popup__photos");o.style.display="block";const n=t.offer.photos;o.innerHTML="",n.forEach((e=>{const t=document.createElement("img");t.classList.add("popup__photo"),t.style.width="45px",t.style.height="40px",t.src=e,t.addEventListener("click",(()=>{window.bigPicture.open(t)})),o.append(t)}))}})(s,r),s.querySelector(".popup__close").addEventListener("click",(()=>{n()})),document.addEventListener("keydown",o),s},remove:n}})(),(()=>{let e,t;const o=()=>{e.remove(),t.remove(),e.removeEventListener("click",o),t.removeEventListener("click",o)};window.addEventListener("keydown",(e=>{window.util.isEscPress(e)&&o()}));window.bigPicture={open:n=>{const r=document.createElement("img");r.src=n.src,r.style.width="auto",r.style.height="auto",r.style.border="10px solid #ffffff",e=(()=>{let e=document.createElement("div");return e.style.position="fixed",e.style.backgroundColor="rgba(0,0,0,0.8)",e.style.left=0,e.style.top=0,e.style.right=0,e.style.bottom=0,e.style.zIndex=99,e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e})(),t=(()=>{let e=document.createElement("button");return e.style.position="fixed",e.style.backgroundColor="transparent",e.style.right=0,e.style.top=0,e.style.width="55px",e.style.height="65px",e.style.display="block",e.style.border="1px solid transparent",e.style.fontSize="50px",e.textContent="×",e.style.color="#ffffff",e.style.padding="0",e.style.cursor="pointer",e.style.zIndex=100,e})(),document.body.appendChild(e),document.body.appendChild(t),r.addEventListener("load",(()=>{e.appendChild(r)})),e.addEventListener("click",(e=>{e.target!==r&&o()})),t.addEventListener("click",o)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={render:t=>{let o=e.cloneNode(!0),n=o.querySelector("img");return o.style.top=t.location.y-44-5+"px",o.style.left=t.location.x-20+"px",n.src=t.author.avatar,n.alt=t.offer.title,o.addEventListener("click",(()=>{let e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active"),o.classList.add("map__pin--active")})),o}}})(),window.debounce=e=>{var t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),s=t.querySelector("#housing-guests"),i=i=>i.filter((i=>{return(t=>o.value===e||t.offer.type===o.value)(i)&&(t=>n.value===e||t.offer.price<1e4&&"low"===n.value||t.offer.price>5e4&&"high"===n.value||t.offer.price>=1e4&&t.offer.price<=5e4&&"middle"===n.value)(i)&&(t=>r.value===e||t.offer.rooms===parseInt(r.value,10))(i)&&(t=>s.value===e||t.offer.guests===parseInt(s.value,10))(i)&&(l=i.offer.features,Array.from(t.querySelectorAll('input[type="checkbox"]:checked')).every((e=>l.includes(e.value))));var l})).slice(0,5);window.filters={setFilteredPins:(e,o)=>{let n=window.debounce((()=>{o(i(e))}));t.addEventListener("change",(()=>{n()})),o(i(e))},clear:()=>{t.reset()}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=e.querySelector(".map__filters-container"),n=document.querySelector(".map__filters"),r=n.querySelectorAll(".map__filter"),s=n.querySelector(".map__features"),i=()=>{window.util.enableElements(r)};window.map={element:e,mapFiltersForm:n,disable:()=>{e.classList.add("map--faded"),window.card.remove(),window.map.removePins(),n.classList.add("ad-form--disabled"),window.util.disableElements(r),s.disabled=!0,window.mainPin.reset()},enable:()=>{e.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),i(),s.disabled=!1},addPins:n=>{t.appendChild((t=>{let n,r=document.createDocumentFragment();for(let s=0;s<t.length;s++)n=window.pin.render(t[s]),n.addEventListener("click",(()=>{var n;n=window.card.create(t[s]),window.card.remove(),e.insertBefore(n,o)})),r.appendChild(n);return r})(n))},removePins:()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{t.removeChild(e)}))},removeActivePin:()=>{let e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")}}})(),(()=>{const e=window.map.element.offsetWidth-32.5,t=document.querySelector(".map__pin--main"),o=t.style.left,n=t.style.top,r=()=>{const e=t.offsetLeft,o=t.offsetTop;let n={};return n=window.map.element.classList.contains("map--faded")?{x:Math.round(e+32.5),y:Math.round(o+32.5)}:{x:Math.round(e+32.5),y:Math.round(o+85)},n};t.addEventListener("mousedown",(o=>{o.preventDefault();let n={x:o.clientX,y:o.clientY};const s=o=>{o.preventDefault();let s=n.x-o.clientX,i=n.y-o.clientY;n={x:o.clientX,y:o.clientY};let l=t.offsetLeft-s,d=t.offsetTop-i;l>=-32.5&&l<=e&&(t.style.left=t.offsetLeft-s+"px"),d>=45&&d<=545&&(t.style.top=t.offsetTop-i+"px"),window.form.setAddressPin(r())},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",i)})),window.mainPin={element:t,getAddress:r,reset:()=>{t.style.left=o,t.style.top=n}}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success"),t=document.querySelector("#error").content.querySelector(".error"),o=e.cloneNode(!0);document.addEventListener("keydown",(e=>{window.util.isEscPress(e)&&o.remove()})),document.addEventListener("click",(e=>{e.target===o&&o.remove()}));const n=t.cloneNode(!0);n.querySelector(".error__button").addEventListener("click",(()=>{n.remove()})),document.addEventListener("keydown",(e=>{window.util.isEscPress(e)&&n.remove()})),document.addEventListener("click",(e=>{e.target===n&&n.remove()})),window.message={showSuccess:()=>{document.querySelector("main").appendChild(o)},showError:e=>{n.style="text-align: center",n.style.display="block",n.style.position="fixed",n.style.zIndex="100",n.style.width="100%",n.style.backgroundColor="rgba(255, 86, 53, 0.8)",n.style.color="#fff",n.style.fontSize="25px",n.style.fontWeight="bold",n.style.lineHeight="65px",n.style.textAlign="center",n.querySelector(".error__message").textContent=e,document.querySelector("main").appendChild(n)}}})(),(()=>{const e=()=>{window.filters.clear(),window.map.disable(),window.form.disable(),window.form.setAddress(window.mainPin.getAddress())},t=()=>{window.map.enable(),window.form.enable(),window.form.setAddress(window.mainPin.getAddress()),window.backend.load((e=>{let t=e.filter((e=>"offer"in e));window.filters.setFilteredPins(t,o)}),r)},o=e=>{window.map.removePins(),window.card.remove(),window.map.addPins(e)};window.form.element.addEventListener("submit",(e=>{e.preventDefault(),window.form.element.checkValidity()&&window.backend.save(new FormData(window.form.element),n,r)})),window.form.resetElement.addEventListener("click",(()=>{e()}));const n=()=>{window.message.showSuccess(),e()},r=()=>{window.message.showError()};window.mainPin.element.addEventListener("mousedown",(e=>{0===e.button&&t()})),window.mainPin.element.addEventListener("keydown",(e=>{window.util.isEnterPress(e)&&t()})),e()})()})();